<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Analysis Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.plot.ly/plotly-latest.min.js">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background-color: #0d6efd;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: 5px;
        }
        .analysis-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .score-item {
            text-align: center;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }
        .score-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #495057;
        }
        .score-value {
            font-size: 24px;
            font-weight: bold;
            color: #0d6efd;
            margin-bottom: 5px;
        }
        .score-description {
            font-size: 12px;
            color: #6c757d;
        }
        .credibility-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .credibility-badge.high {
            background-color: #d4edda;
            color: #155724;
        }
        .credibility-badge.medium {
            background-color: #fff3cd;
            color: #856404;
        }
        .credibility-badge.low {
            background-color: #f8d7da;
            color: #721c24;
        }
        .similar-article {
            background-color: white;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .article-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
            font-size: 14px;
            color: #6c757d;
        }
        .article-meta i {
            margin-right: 3px;
        }
        #loadingIndicator {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        #analysisResults {
            display: none;
        }
        .chart-container {
            height: 400px;
            margin-bottom: 30px;
        }
        .form-container {
            background-color: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        .btn-custom {
            background-color: #0d6efd;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .btn-custom:hover {
            background-color: #0b5ed7;
            color: white;
        }
        .navbar {
            background-color: #f8f9fa;
            padding: 15px 0;
            margin-bottom: 20px;
        }
        .nav-link {
            color: #0d6efd;
            font-weight: 500;
            margin: 0 10px;
        }
        .nav-link:hover {
            color: #0b5ed7;
        }
        .footer {
            background-color: #0d6efd;
            color: white;
            text-align: center;
            padding: 20px 0;
            margin-top: 50px;
        }
        textarea.form-control {
            min-height: 200px;
            resize: vertical;
        }
        .detail-item {
            margin-bottom: 20px;
        }
        .detail-item h4 {
            color: #0d6efd;
            margin-bottom: 10px;
        }
        .badge {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .list-unstyled li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="/">News Analysis Tool</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/faq">FAQ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/feedback">Feedback</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header text-center mb-4">
            <h1>Media Credibility Index Tool</h1>
            <p class="lead">Setting the Standard for Media Trust</p>
        </div>

        <div class="form-container">
            <h2>Enter Article for Analysis</h2>
            <form id="analysisForm">
                <div class="mb-3">
                    <label for="articleInput" class="form-label">Article Text or URL</label>
                    <textarea class="form-control" id="articleInput" rows="10" placeholder="Paste article text here or enter a URL..."></textarea>
                </div>
                <div class="mb-3">
                    <label for="sourceName" class="form-label">Source Name (optional)</label>
                    <input type="text" class="form-control" id="sourceName" placeholder="Enter source name if known">
                </div>
                <button type="button" id="analyzeBtn" class="btn btn-custom">Analyze Article</button>
            </form>
        </div>

        <div id="loadingIndicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Analyzing article content...</p>
        </div>

        <div id="analysisResults">
            <div class="analysis-section">
                <h2>Analysis Results</h2>
                <div id="analysisOutput"></div>
            </div>

            <div class="chart-container">
                <div id="articleChart"></div>
            </div>

            <div class="chart-container">
                <div id="sourceChart"></div>
            </div>

            <div class="analysis-section">
                <h2>Same Topic Articles</h2>
                <div id="sameTopicArticles"></div>
                <button id="showMoreBtn" class="btn btn-custom" style="display: none;">Show More Similar Articles</button>
            </div>

            <div class="analysis-section">
                <h2>Analysis History</h2>
                <div id="analysisHistory"></div>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="container">
            <p>&copy; 2025 Media Index Tool. All rights reserved.</p>
            <p><a href="/faq" class="text-white">FAQ</a> | <a href="/feedback" class="text-white">Feedback</a></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        // DOM elements
        const elements = {
            articleInput: document.getElementById('articleInput'),
            sourceName: document.getElementById('sourceName'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            analysisResults: document.getElementById('analysisResults'),
            analysisOutput: document.getElementById('analysisOutput'),
            sameTopicArticles: document.getElementById('sameTopicArticles'),
            showMoreBtn: document.getElementById('showMoreBtn'),
            articleChart: document.getElementById('articleChart'),
            sourceChart: document.getElementById('sourceChart'),
            analysisHistory: document.getElementById('analysisHistory')
        };

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalysisHistory();
            loadSourceCredibilityChart();

            elements.analyzeBtn.addEventListener('click', analyzeArticle);
            elements.showMoreBtn.addEventListener('click', loadMoreSimilarArticles);
        });

        // Function to analyze article
        function analyzeArticle() {
            const inputText = elements.articleInput.value.trim();
            const sourceName = elements.sourceName ? elements.sourceName.value.trim() : '';

            if (!inputText) {
                showAlert('Please enter article text or URL', 'danger');
                return;
            }

            // Show loading indicator
            elements.loadingIndicator.style.display = 'block';
            elements.analysisResults.style.display = 'none';

            // Prepare request data
            const requestData = {
                input_text: inputText,
                source_name_manual: sourceName
            };

            // Send request to server for analysis
            fetch('/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        let errorMessage = err.error || 'Network response was not ok';

                        // If there are suggestions, display them
                        if (err.suggestions && err.suggestions.length > 0) {
                            errorMessage += '<ul>';
                            err.suggestions.forEach(suggestion => {
                                errorMessage += `<li>${suggestion}</li>`;
                            });
                            errorMessage += '</ul>';
                        }

                        // If there are details, add them
                        if (err.details) {
                            errorMessage += `<br><br>Details: ${err.details}`;
                        }

                        throw new Error(errorMessage);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Hide loading indicator
                elements.loadingIndicator.style.display = 'none';

                // Show analysis results
                elements.analysisResults.style.display = 'block';
                elements.showMoreBtn.style.display = 'block';

                // Display analysis results
                if (data.output && data.output.output_md) {
                    elements.analysisOutput.innerHTML = marked.parse(data.output.output_md);
                } else {
                    elements.analysisOutput.innerHTML = '<div class="alert alert-warning">No analysis results available</div>';
                }

                // Render charts
                if (data.scores_for_chart) {
                    renderArticleCredibilityChart(data.scores_for_chart);
                }

                if (data.source_credibility_data) {
                    renderSourceCredibilityChart(data.source_credibility_data);
                }

                // Display same topic articles
                if (data.same_topic_html) {
                    elements.sameTopicArticles.innerHTML = data.same_topic_html;
                    currentPage = 1;
                } else {
                    elements.sameTopicArticles.innerHTML = '<div class="alert alert-info">No similar articles found</div>';
                    elements.showMoreBtn.style.display = 'none';
                }

                // Scroll to results
                elements.analysisResults.scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                elements.loadingIndicator.style.display = 'none';
                console.error('Error:', error);
                showAlert(error.message, 'danger');
            });
        }

        // Function to load more similar articles
        function loadMoreSimilarArticles() {
            fetch('/same_topic_articles?page=' + (currentPage + 1))
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.same_topic_html) {
                    elements.sameTopicArticles.innerHTML += data.same_topic_html;
                    currentPage++;

                    if (!data.has_more) {
                        elements.showMoreBtn.style.display = 'none';
                    }
                } else {
                    elements.showMoreBtn.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error loading more articles:', error);
                showAlert('Error loading more articles: ' + error.message, 'danger');
            });
        }

        // Function to load analysis history
        function loadAnalysisHistory() {
            fetch('/analysis-history')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.history_html) {
                    elements.analysisHistory.innerHTML = data.history_html;
                }
            })
            .catch(error => {
                console.error('Error loading analysis history:', error);
                elements.analysisHistory.innerHTML = '<div class="alert alert-warning">Error loading analysis history</div>';
            });
        }

        // Function to load source credibility chart
        function loadSourceCredibilityChart() {
            fetch('/source-credibility-chart')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.data) {
                    renderSourceCredibilityChart(data.data);
                }
            })
            .catch(error => {
                console.error('Error loading source credibility chart:', error);
                elements.sourceChart.innerHTML = '<div class="alert alert-warning">Error loading source credibility data</div>';
            });
        }

        // Function to render article credibility chart
        function renderArticleCredibilityChart(scores) {
            const data = [{
                type: 'barpolar',
                r: Object.values(scores),
                theta: Object.keys(scores),
                name: 'Credibility Scores',
                marker: {
                    color: Object.values(scores).map(score => {
                        if (score >= 70) return 'rgb(75, 192, 192)';
                        if (score >= 40) return 'rgb(255, 206, 86)';
                        return 'rgb(255, 99, 132)';
                    }),
                    line: {
                        color: Object.values(scores).map(score => {
                            if (score >= 70) return 'rgb(50, 150, 150)';
                            if (score >= 40) return 'rgb(200, 170, 50)';
                            return 'rgb(200, 70, 100)';
                        }),
                        width: 2
                    }
                }
            }];

            const layout = {
                title: 'Article Credibility Analysis',
                font: { size: 12 },
                legend: { font: { size: 12 } },
                polar: {
                    radialaxis: {
                        visible: true,
                        range: [0, 100]
                    }
                },
                margin: { t: 50, b: 50 }
            };

            Plotly.newPlot('articleChart', data, layout);
        }

        // Function to render source credibility chart
        function renderSourceCredibilityChart(data) {
            const sources = data.sources;
            const credibilityScores = data.credibility_scores;
            const highCounts = data.high_counts;
            const mediumCounts = data.medium_counts;
            const lowCounts = data.low_counts;

            const trace1 = {
                x: sources,
                y: credibilityScores,
                name: 'Credibility Score',
                type: 'bar',
                marker: {
                    color: credibilityScores.map(score => {
                        if (score >= 0.7) return 'rgb(75, 192, 192)';
                        if (score >= 0.4) return 'rgb(255, 206, 86)';
                        return 'rgb(255, 99, 132)';
                    })
                }
            };

            const trace2 = {
                x: sources,
                y: highCounts,
                name: 'High Credibility',
                type: 'scatter',
                mode: 'lines+markers',
                marker: { color: 'rgb(75, 192, 192)' }
            };

            const trace3 = {
                x: sources,
                y: mediumCounts,
                name: 'Medium Credibility',
                type: 'scatter',
                mode: 'lines+markers',
                marker: { color: 'rgb(255, 206, 86)' }
            };

            const trace4 = {
                x: sources,
                y: lowCounts,
                name: 'Low Credibility',
                type: 'scatter',
                mode: 'lines+markers',
                marker: { color: 'rgb(255, 99, 132)' }
            };

            const layout = {
                title: 'Source Credibility Analysis',
                xaxis: { title: 'News Sources' },
                yaxis: { title: 'Count' },
                barmode: 'group',
                margin: { t: 50, b: 100 }
            };

            Plotly.newPlot('sourceChart', [trace1, trace2, trace3, trace4], layout);
        }

        // Function to show alert messages
        function showAlert(message, type) {
            const alertContainer = document.createElement('div');
            alertContainer.className = `alert alert-${type} alert-dismissible fade show`;
            alertContainer.role = 'alert';
            alertContainer.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

            // Add alert to the top of the container
            const container = document.querySelector('.container');
            if (container) {
                container.prepend(alertContainer);

                // Auto-close the alert after 10 seconds
                setTimeout(() => {
                    const alert = bootstrap.Alert.getOrCreateInstance(alertContainer);
                    alert.close();
                }, 10000);
            }
        }

        // Initialize current page for similar articles
        let currentPage = 1;
    </script>
</body>
</html>
